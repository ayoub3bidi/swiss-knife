name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'swiss_knife/**'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'swiss_knife/**'
      - 'README.md'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  lint-docs:
    name: Lint Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install markdownlint-cli2
    
    - name: Lint Markdown files
      run: |
        markdownlint-cli2 "**/*.md" "#node_modules" "#venv"
    
    - name: Check documentation links
      run: |
        # Check for broken internal links
        python -c "
        import os
        import re
        from pathlib import Path
        
        def check_links():
            errors = []
            docs_dir = Path('docs')
            readme = Path('README.md')
            
            # Get all markdown files
            md_files = list(docs_dir.glob('**/*.md')) + [readme]
            
            for md_file in md_files:
                content = md_file.read_text()
                # Find markdown links [text](link)
                links = re.findall(r'\[([^\]]+)\]\(([^)]+)\)', content)
                
                for text, link in links:
                    # Check internal links (relative paths)
                    if not link.startswith(('http', 'mailto:', '#')):
                        link_path = md_file.parent / link
                        if not link_path.exists():
                            errors.append(f'{md_file}: Broken link to {link}')
            
            if errors:
                print('Documentation link errors:')
                for error in errors:
                    print(f'  {error}')
                exit(1)
            else:
                print('All documentation links are valid')
        
        check_links()
        "

  validate-examples:
    name: Validate Code Examples
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[all]
    
    - name: Validate Python examples in documentation
      run: |
        python -c "
        import ast
        import re
        from pathlib import Path
        
        def validate_python_examples():
            errors = []
            docs_dir = Path('docs')
            readme = Path('README.md')
            
            # Get all markdown files
            md_files = list(docs_dir.glob('**/*.md')) + [readme]
            
            for md_file in md_files:
                content = md_file.read_text()
                # Find Python code blocks
                python_blocks = re.findall(r'```python\n(.*?)\n```', content, re.DOTALL)
                
                for i, code_block in enumerate(python_blocks):
                    try:
                        # Try to parse the code
                        ast.parse(code_block)
                    except SyntaxError as e:
                        errors.append(f'{md_file} block {i+1}: {e}')
            
            if errors:
                print('Python syntax errors in documentation:')
                for error in errors:
                    print(f'  {error}')
                exit(1)
            else:
                print('All Python examples are syntactically valid')
        
        validate_python_examples()
        "
    
    - name: Test CLI examples
      run: |
        # Test that CLI commands in documentation work
        echo "Testing CLI help commands..."
        sk-duplicates --help > /dev/null
        echo "âœ… CLI examples validated"

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: [lint-docs, validate-examples]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[all]
        pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin
    
    - name: Generate API documentation
      run: |
        # Generate API docs from docstrings
        python -c "
        import inspect
        import swiss_knife
        from pathlib import Path
        
        def generate_api_docs():
            api_dir = Path('docs/api')
            api_dir.mkdir(exist_ok=True)
            
            # Generate module documentation
            modules = [
                'swiss_knife.core',
                'swiss_knife.file_management',
                'swiss_knife.text_processing', 
                'swiss_knife.automation'
            ]
            
            for module_name in modules:
                try:
                    module = __import__(module_name, fromlist=[''])
                    doc_content = f'# {module_name}\n\n'
                    
                    if module.__doc__:
                        doc_content += f'{module.__doc__}\n\n'
                    
                    # Get all public functions and classes
                    for name, obj in inspect.getmembers(module):
                        if not name.startswith('_') and (inspect.isfunction(obj) or inspect.isclass(obj)):
                            doc_content += f'## {name}\n\n'
                            if obj.__doc__:
                                doc_content += f'{obj.__doc__}\n\n'
                    
                    # Write to file
                    doc_file = api_dir / f'{module_name.split(\".\")[-1]}.md'
                    doc_file.write_text(doc_content)
                    print(f'Generated {doc_file}')
                    
                except ImportError as e:
                    print(f'Could not import {module_name}: {e}')
        
        generate_api_docs()
        "
    
    - name: Create mkdocs.yml
      run: |
        cat > mkdocs.yml << 'EOF'
        site_name: Swiss Knife Documentation
        site_description: A comprehensive collection of Python automation tools
        site_url: https://ayoub3bidi.github.io/swiss-knife/
        repo_url: https://github.com/ayoub3bidi/swiss-knife
        repo_name: ayoub3bidi/swiss-knife
        
        theme:
          name: material
          palette:
            - scheme: default
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-7
                name: Switch to dark mode
            - scheme: slate
              primary: blue
              accent: blue
              toggle:
                icon: material/brightness-4
                name: Switch to light mode
          features:
            - navigation.tabs
            - navigation.sections
            - navigation.expand
            - navigation.top
            - search.highlight
            - content.code.copy
        
        plugins:
          - search
          - mermaid2
        
        nav:
          - Home: index.md
          - Getting Started:
            - Installation: installation.md
            - Quick Start: quickstart.md
          - User Guide:
            - CLI Reference: cli-reference.md
            - Python API: api-reference.md
          - Development:
            - Architecture: ARCHITECTURE.md
            - Development Guide: DEVELOPMENT.md
            - Contributing: CONTRIBUTING.md
          - API Reference:
            - Core: api/core.md
            - File Management: api/file_management.md
            - Text Processing: api/text_processing.md
            - Automation: api/automation.md
          - About:
            - Code of Conduct: CODE_OF_CONDUCT.md
            - License: license.md
        
        markdown_extensions:
          - admonition
          - codehilite
          - pymdownx.superfences:
              custom_fences:
                - name: mermaid
                  class: mermaid
                  format: !!python/name:mermaid2.fence_mermaid
        EOF
    
    - name: Create documentation index
      run: |
        cat > docs/index.md << 'EOF'
        # Swiss Knife Documentation
        
        Welcome to Swiss Knife, a comprehensive collection of Python automation tools designed for productivity, security, and ease of use.
        
        ## What is Swiss Knife?
        
        Swiss Knife is a production-ready Python package that provides automation tools through both programmatic APIs and command-line interfaces. It emphasizes security, testability, and extensibility.
        
        ## Quick Start
        
        ```bash
        # Install Swiss Knife
        pip install swiss-knife
        
        # Find duplicate files
        sk-duplicates ~/Documents --algorithm sha256
        
        # Generate secure passwords
        sk-password --length 16 --symbols
        ```
        
        ## Features
        
        - **File Management**: Duplicate detection, bulk renaming, symlink cleanup
        - **Text Processing**: CSV conversion, text merging, word analysis
        - **Security & Automation**: Password generation, strength analysis
        - **Network & Web**: Website monitoring, QR code generation
        - **System Utilities**: Resource monitoring, disk analysis
        
        ## Getting Help
        
        - [Installation Guide](installation.md)
        - [CLI Reference](cli-reference.md)
        - [Python API](api-reference.md)
        - [Contributing](CONTRIBUTING.md)
        
        ## Community
        
        - [GitHub Repository](https://github.com/ayoub3bidi/swiss-knife)
        - [Issue Tracker](https://github.com/ayoub3bidi/swiss-knife/issues)
        - [Discussions](https://github.com/ayoub3bidi/swiss-knife/discussions)
        EOF
    
    - name: Build documentation
      run: |
        mkdocs build
    
    - name: Upload documentation artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./site

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
